#+SETUPFILE:./hugo_setup.org
#+HUGO_SECTION: zettels
#+HUGO_SLUG: virtualization
#+TITLE: Virtualization

Go back to inbox: [[file:2020-03-02.org][Other Brain Inbox]]

* Virtualbox

** Vagrant
[[file:/vagrant/Vagrantfile][Vagrantfile with nodejs and emacs]]
[[file:/vagrant/sh/][Provision with shell]]
[[file:/vagrant/ansible/][Provision with ansible]]

+ Be careful, don't halt your virtual machine within the virtualbox application, which may cause infinite reboot of your system

Always use the =vagrant halt= to gracefully shutdown the system.

*** Making Snapshots

#+BEGIN_SRC shell
vagrant snapshot list
vagrant snapshot save mysnapshot
vagrant ssh-config
vagrant up
vagrant halt
#+BEGIN_SRC


How to recover the shared_folders in vagrant after update the linux kernel

[[https://stackoverflow.com/questions/27992354/vagrant-error-failed-to-mount-folders-in-linux-guest-after-halt-or-reload][update kernel will cause error]]

*** Updating the plugin to detect any plugin error

+ Just open your cmd or powershell or mitty to install vagrant guest tools

#+BEGIN_SRC shell
vagrant plugin install vbguest
#+BEGIN_SRC

*** Updating the kernel and reload vboxguest modules

+ Login your vagrant vm and run the following command

#+BEGIN_SRC shell
sudo apt install -y linux-headers-4.19.0-8-686-pae
sudo /sbin/rcvboxadd setup
sudo /sbin/rcvboxadd quicksetup all
sudo /sbin/rcvboxadd quicksetup 4.19.0-8-686-pae
#+END_SRC

+ Restart the system to get ready for vboxguest working with new kernel

#+BEGIN_SRC shell
vagrant halt
vagrant up
#+BEGIN_SRC

* VPS

** Setting google cloud vps

+ first register your google cloud account

+ run the =trojan= install script

+ change password of root

#+BEGIN_SRC shell
# Enter root
sudo -i
#+END_SRC

+ install packages

#+BEGIN_SRC shell
apt update && apt upgrade
apt install -y common-properties build-esentials
#+END_SRC

** Setting domain and use CDN

Visit tencent cloud to register domain name https://cloud.tencent.com/

- add A record to ip address
  change DNS to cloudflare dns
  Add MX record to email domain

Visit cloudflare to use a CDN https://dash.cloudflare.com/

Cloudflare åç§°æœåŠ¡å™¨
è¦ä½¿ç”¨ Cloudflareï¼Œè¯· [æ›´æ”¹åç§°æœåŠ¡å™¨]
(https://support.cloudflare.com/hc/articles/205195708)æˆ–æƒå¨
DNS æœåŠ¡å™¨ã€‚è¿™äº›æœåŠ¡å™¨æ˜¯åˆ†é…çš„ Cloudflare åç§°æœåŠ¡å™¨ã€‚

~daniella.ns.cloudflare.com~
~sage.ns.cloudflare.com~

*** Setting ssh client config
Setting you ssh like this

Read more about SSH config files: https://linux.die.net/man/5/ssh_config

My key file [[file:d:/Dropbox/config/ssh/][My ssh files]]

#+BEGIN_SRC info
Host xunqinji
    HostName xunqinji.top
    User root
    Port 22
Host dongxishijie
    HostName dongxishijie.xyz
    User root
    Port 22
Host dxsjv
    HostName dongxishijie.xyz
    User vagrant
    Port 22
Host huawei
    HostName 192.168.1.189
    User root
    Port 22
Host xiaomi
    HostName 192.168.1.1
    User vagrant
    Port 22
Host home
    HostName 186.90.238.153
    User vagrant
    Port 8022

#+END_SRC

** Install proxy server on VPS

[[http://souclou.com/?p=23403][æœ€æ–°æœ€ç®€å•æœ€å¿«é€Ÿä½¿ç”¨VULTR VPSæ­å»ºé«˜é€ŸTROJANç¿»å¢™æ–¹å¼]]
[[https://iyideng.com/truth/cgfw/self-built-trojan-server-tutorial-vultr.html][ã€ŽVPSæ­å»ºTrojanæ•™ç¨‹ã€ä½¿ç”¨Vultræ­å»ºTrojanæœåŠ¡å™¨ï¼Œéƒ¨ç½²BBR+é”é€ŸåŠ é€Ÿç§‘å­¦ä¸Šç½‘ï¼]]
[[http://luyiminggonnabeok.cn/2019/12/07/%E4%B8%80%E9%94%AE%E8%84%9A%E6%9C%AC%E6%90%AD%E5%BB%BATrojan%E6%A2%AF%E5%AD%90%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/][ä¸€é”®è„šæœ¬æ­å»ºç§‘å­¦ä¸Šç½‘Trojanæ¢¯å­(è‡ªå»ºVPN)è¯¦ç»†æ•™ç¨‹]]
[[http://luyiminggonnabeok.cn/2018/08/10/%E5%8D%81%E5%88%86%E9%92%9F%E6%90%AD%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84SSR%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91%E6%A2%AF%E5%AD%90/][ååˆ†é’Ÿæ­å»ºè‡ªå·±çš„ç§‘å­¦ä¸Šç½‘SSRæ¢¯å­ï¼ˆè‡ªå»ºVPNï¼‰]]
[[https://www.youtube.com/watch?v=7ewqVuRXpto][é›¶æˆæœ¬ä½“éªŒä¸€ä¸‹å…è´¹çš„è½¯è·¯ç”±]]
[[https://mtom.ml/798.html][ä¸æ±‚äººGitHub Actions äº‘menuconfigè‡ªå®šä¹‰é…ç½®ç¼–è¯‘OpenWrt PassWallå›ºä»¶]]

** Cloud compile openwrt firmware

æ„Ÿè°¢P3TERX/Actions-OpenWrtå’ŒLienol/openwrt

æœ¬æ–‡ä»‹ç»GitHub Actionsåœ¨çº¿è‡ªå®šä¹‰ç¼–è¯‘ OpenWrt åŒ…å«PassWallæœåŠ¡å›ºä»¶çš„è¿‡ç¨‹ï¼Œå¯ä»¥é€‰æ‹©Lienol OpenWrtçš„ä¸åŒåˆ†æ”¯æºç ã€‚

é¦–å…ˆä½ è¦æœ‰GitHubè´¦å·ï¼ŒåŸºæœ¬çš„GitHubä½¿ç”¨èƒ½åŠ›ï¼ŒçŸ¥é“Actionsæ·»åŠ workflowsï¼›çŸ¥é“è‡ªå·±è·¯ç”±å™¨çš„ç¡¬ä»¶é…ç½®ï¼›æŸ¥è¯¢openwrtæ˜¯å¦é€‚åˆä½ çš„è·¯ç”±å™¨ï¼Œäº†è§£openwrtç¼–è¯‘æ­¥éª¤ï¼›ä»€ä¹ˆéƒ½ä¸çŸ¥é“å°±å…ˆå­¦ä¹ äº†å†å¾€ä¸‹çœ‹ðŸ‘€å§ï¼

1ã€ç™»é™†ä½ çš„GitHubè´¦å·ï¼Œæœç´¢Lancenas/actions-openwrt-passwall


#+CAPTION: This is the caption for the next figure link (or table)
#+NAME:   fig:fork git repository
[[https://mtom.ml/wordpress/wp-content/uploads/2020/02/Xnip2020-02-17_11-44-26-1.webp][fork git repository]]

æ‰“å¼€Lancenas/actions-openwrt-passwall ç‚¹å‡»å³ä¸Šfork


forkå¯ä»¥è‡ªå®šä¹‰åç§°

æŒ‰å›¾ç¤ºè¯´æ˜Žç¼–è¾‘æµç¨‹æ–‡ä»¶ï¼Œå¦å¤–å¯ä»¥ä¿®æ”¹REPO_URL: ä¸åŒåº“åœ°å€ï¼›
REPO_BRANCH: ä¸åŒåˆ†æ”¯
LienolOpenWrtæºç ä¸ºä¾‹
- [] åˆ†æ”¯dev-master æ¿€è¿›ï¼›
- [] dev-19.07 OpenWrtå®˜æ–¹å¹³ç¨³ç‰ˆï¼›
- [] dev-lean-lede leançš„æºç ï¼‰

å›¾ç¤ºä»¥ç‚¹å‡»â€œstarâ€è§¦å‘ç¼–è¯‘ä¸ºä¾‹ï¼Œä¿®æ”¹åŽä¿å­˜ï¼Œé€€å‡ºç¼–è¾‘ã€‚

åœ¨ä½ çš„è´¦å·ä¸‹ï¼ŒåŽé¢æ‰€æœ‰æ­¥éª¤éƒ½æ˜¯åœ¨ä½ çš„è´¦å·ä¸‹æ“ä½œï¼Œç‚¹å‡»å³ä¸Šstar

è¿™æ—¶å·²ç»å¼€å§‹ç¼–è¯‘äº†ï¼Œç‚¹å‡»ActionsæŸ¥çœ‹å·¥ä½œæµç¨‹


#+BEGIN_SRC yaml
name: Build OpenWrt

on:
  release:
    types: [published]
  push:
    branches:
      - master
#    paths:
#      - '.config'
#  schedule:
#    - cron: 0 8 * * 5
#  watch:
#    types: [started]

env:
  REPO_URL: https://github.com/Lienol/openwrt
  REPO_BRANCH: dev-19.07
  CONFIG_FILE: .config
  DIY_SH: diy.sh
  FREE_UP_DISK: false
  SSH_ACTIONS: true
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@master

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo swapoff /swapfile
        sudo rm -rf /swapfile /etc/apt/sources.list.d/*
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler
        curl -fsSL https://raw.githubusercontent.com/P3TERX/dotfiles/master/.bashrc >> ~/.bashrc
    - name: Free up disk space
      if: env.FREE_UP_DISK == 'true'
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /usr/share/dotnet
        docker rmi `docker images -q`
        sudo -E apt-get -q purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php*
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
    - name: Clone source code
      run: git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt

    - name: Update feeds
      run: cd openwrt && ./scripts/feeds update -a

    - name: Install feeds
      run: cd openwrt && ./scripts/feeds install -a

    - name: Load custom configuration
      run: |
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        chmod +x $DIY_SH
        cd openwrt
        ../$DIY_SH
        make defconfig
    - name: SSH connection to Actions
      uses: P3TERX/debugger-action@master
      if: env.SSH_ACTIONS == 'true'

    - name: Download package
      id: package
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
    - name: Compile the firmware
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 V=s
        echo "::set-output name=status::success"
    - name: Upload bin directory
      uses: actions/upload-artifact@master
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_directory
        path: openwrt/bin

    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "::set-env name=FIRMWARE::$(pwd)"
        echo "::set-output name=status::success"
    - name: Upload firmware directory
      uses: actions/upload-artifact@master
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware
        path: ${{ env.FIRMWARE }}
#+END_SRC
ç‚¹å‡»build OpenWrt æŸ¥çœ‹æµç¨‹

æ‰“å¼€buildï¼ŒSSH connection to Actionsæ­¥éª¤ä¼šå‡ºçŽ°å¦‚å›¾ä¿¡æ¯ï¼ŒæŒ‰å›¾æ ‡æ³¨é€‰æ‹©ä¸€ç§æ–¹å¼é“¾æŽ¥äº‘action

æ‰“å¼€ç•Œé¢è¾“å…¥ï¼šcd openwrt && make menuconfigï¼Œè¿›å…¥é…ç½®é€‰æ‹©ç•Œé¢ï¼Œæ ¹æ®ä½ è·¯ç”±å™¨èŠ¯ç‰‡å’Œéœ€è¦çš„æœåŠ¡é€‰æ‹©ï¼ˆæ–°æ‰‹å‚è€ƒOpenWrt MenuConfigè®¾ç½®å’ŒLuCIæ’ä»¶é€‰é¡¹è¯´æ˜Žï¼‰ã€‚

å®ŒæˆåŽæŒ‰å¿«æ·é”®Ctrl+Dæˆ–æ‰§è¡Œexitå‘½ä»¤é€€å‡ºï¼ŒåŽç»­ç¼–è¯‘å·¥ä½œå°†è‡ªåŠ¨è¿›è¡Œï¼Œéœ€è¦2å°æ—¶å·¦å³ã€‚ç¼–è¯‘å‡ºé”™ä¸­æ–­ä¼šæœ‰Emailé€šçŸ¥ã€‚é€šè¿‡æ—¥å¿—å¯ä»¥æŸ¥è¯¢å‡ºé”™åŽŸå› ã€‚

ç¼–è¯‘æˆåŠŸå·¥ä½œæµç¨‹å‰å‡ºçŽ°ç»¿è‰²âˆšï¼Œæ‰“å¼€æµç¨‹å¦‚ä¸‹å›¾ä¸‹è½½ç¼–è¯‘å¥½çš„å›ºä»¶

ç‚¹å‡»ä¸‹è½½ï¼šOpenWrt_firmware

GitHub Actionsäº‘é…ç½®ç¼–è¯‘äº†Leanâ€™s OpenWrt å’ŒLienolâ€˜s OpenWrt çš„X86_64å›ºä»¶ä¸‹è½½é“¾æŽ¥ä¾›å¤§å®¶æµ‹è¯•ã€‚

** ä¸€é”®å®‰è£…è„šæœ¬
#+BEGIN_SRC bash
#!/bin/bash

#ä»…ä»…æžcentos7
if [ ! -e '/etc/redhat-release' ]; then
echo "ä»…æ”¯æŒcentos7"
exit
fi
if  [ -n "$(grep ' 6\.' /etc/redhat-release)" ] ;then
echo "ä»…æ”¯æŒcentos7"
exit
fi

install_docker(){

	yum remove -y docker docker-client docker-client-latest docker-common docker-latest  docker-latest-logrotate docker-logrotate docker-selinux docker-engine-selinux docker-engine
	yum install -y yum-utils device-mapper-persistent-data lvm2
	yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
	yum makecache fast
	yum -y install docker-ce
	systemctl start docker
	systemctl enable docker

}

config_website(){

	cd /usr/src/trojan/web
	wget https://github.com/atrandys/trojan/raw/master/index.zip
	unzip index.zip

}

uninstall_trojan(){
	docker update --restart=no trojan
	docker stop trojan
	docker rm trojan
	rm -rf /usr/src/trojan/
	echo "================="
	echo "    å¸è½½å®Œæˆ"
	echo "================="
}

config_trojan(){

yum -y install  wget unzip vim tcl expect expect-devel
mkdir /usr/src/trojan
mkdir /usr/src/trojan/web
cd /usr/src/trojan
read -p "è¾“å…¥ä½ çš„VPSç»‘å®šçš„åŸŸåï¼š" domain
SUBJECT="/C=US/ST=Mars/L=iTranswarp/O=iTranswarp/OU=iTranswarp/CN=$domain"
echo "============================"
echo " æŽ¥ä¸‹æ¥éœ€è¦è®¾å®šå¯†ç ï¼Œè¾“å…¥ä¸¤æ¬¡ï¼ˆéšæ„è®¾ç½®ï¼Œ5-10ä½ï¼‰"
echo "============================"
openssl genrsa -des3 -out private.key 1024
echo "============================"
echo " æŽ¥ä¸‹æ¥éœ€è¦è¾“å…¥åˆšè®¾å®šçš„å¯†ç "
echo "============================"
openssl req -new -subj $SUBJECT -key private.key -out private.csr
echo "============================"
echo " å†æ¬¡è¾“å…¥åˆšè®¾å®šçš„å¯†ç "
echo "============================"
mv private.key private.or.key
openssl rsa -in private.or.key -out private.key
openssl x509 -req -days 3650 -in private.csr -signkey private.key -out private.crt

cat > /usr/src/trojan/server.conf <<-EOF
{
    "run_type": "server",
    "local_addr": "0.0.0.0",
    "local_port": 443,
    "remote_addr": "127.0.0.1",
    "remote_port": 80,
    "password": [
        "password1"
    ],
    "log_level": 1,
    "ssl": {
        "cert": "/usr/src/trojan/private.crt",
        "key": "/usr/src/trojan/private.key",
        "key_password": "",
        "cipher": "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256",
        "prefer_server_cipher": true,
        "alpn": [
            "http/1.1"
        ],
        "reuse_session": true,
        "session_ticket": false,
        "session_timeout": 600,
        "plain_http_response": "",
        "curves": "",
        "dhparam": ""
    },
    "tcp": {
        "no_delay": true,
        "keep_alive": true,
        "fast_open": false,
        "fast_open_qlen": 20
    },
    "mysql": {
        "enabled": false,
        "server_addr": "127.0.0.1",
        "server_port": 3306,
        "database": "trojan",
        "username": "trojan",
        "password": ""
    }
}
EOF

echo "============================"
echo " è®¾ç½®éªŒè¯å¯†ç ï¼ŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä½¿ç”¨ç›¸åŒå¯†ç "
echo "============================"
read -p "è®¾ç½®å¯†ç ï¼š" mypassword
sed -i "s/password1/$mypassword/" /usr/src/trojan/server.conf

}

start_docker(){

    sudo firewall-cmd --zone=public --add-port=80/tcp --permanent
	sudo firewall-cmd --zone=public --add-port=443/tcp --permanent
	sudo firewall-cmd --reload
	docker run --name trojan --restart=always -d -p 80:80 -p 443:443 -v /usr/src/trojan:/usr/src/trojan  atrandys/trojan sh -c "/etc/init.d/nginx start && trojan -c /usr/src/trojan/server.conf"
	echo "============================"
	echo "       trojanå¯åŠ¨å®Œæˆ"
	echo "============================"
}

start_menu(){
    clear
    echo "========================="
    echo " ä»‹ç»ï¼šé€‚ç”¨äºŽCentOS7"
    echo " ä½œè€…ï¼šatrandys"
    echo " ç½‘ç«™ï¼šwww.atrandys.com"
    echo " Youtubeï¼šatrandys"
    echo "========================="
    echo "1. å®‰è£…Trojan"
    echo "2. å¸è½½Trojan"
    echo "3. é€€å‡º"
    echo
    read -p "è¯·è¾“å…¥æ•°å­—:" num
    case "$num" in
    	1)
	install_docker
	config_trojan
	config_website
	start_docker
	;;
	2)
	uninstall_trojan
	;;
	3)
	exit 1
	;;
	*)
	clear
	echo "è¯·è¾“å…¥æ­£ç¡®æ•°å­—"
	sleep 5s
	start_menu
	;;
    esac
}

start_menu

#+END_SRC
** Setting proxy in your office and home
[[file:~/Dropbox/config/proxy/proxy_mfa.pac][Setting proxy in mfa]]
[[file:~/Dropbox/config/proxy/proxy_mini.pac][Setting proxy in mac mini]]


å¦‚ä½•å°†ä¸¤ä¸ªå­ç½‘è¿›è¡Œè¿žæŽ¥

- çŽ¯å¢ƒï¼š åŠžå…¬å®¤
  æ¡Œé¢ç”µè„‘ipåœ°å€ï¼š10.10.49.41
  ç½‘å…³ipåœ°å€: 10.10.49.1
  æ— çº¿è·¯ç”±å™¨ipåœ°å€: 10.10.49.48

- æ— çº¿å±€åŸŸç½‘DHCP åˆ†é…

| ä¸»æœºå                    |     IPv4 åœ°å€ | MAC åœ°å€          |
|---------------------------+---------------+-------------------|
| iPhone                    | 192.168.1.108 | d0:03:4b:7b:4d:34 |
|---------------------------+---------------+-------------------|
| SC-202002251426           | 192.168.1.193 | 44:6d:57:eb:13:2f |
|---------------------------+---------------+-------------------|
| GEM-703L-9acf2abc18b68033 | 192.168.1.189 | 64:a6:51:ba:19:49 |
|---------------------------+---------------+-------------------|
| Max-iPhone                | 192.168.1.182 | c0:a6:00:49:7f:4e |
|---------------------------+---------------+-------------------|
| LGwebOSTV                 | 192.168.1.156 | 2c:2b:f9:19:86:c4 |
|---------------------------+---------------+-------------------|

- windowsä¸»æœºä¸Šä½¿ç”¨ç®¡ç†å‘˜æƒé™æ‰§è¡Œä»¥ä¸‹å‘½ä»¤

è¿™ä¸ªå‘½ä»¤ä¸»è¦çš„åŠŸèƒ½æ˜¯æŠŠ =10.10.49.48= ä½œä¸ºç½‘å…³ï¼Œè®¿é—® =192.168.1.0= åˆ°
=192.16ï¼š8.1.254= çš„ç½‘ç»œä¸»æœº

[[../attach/subnet_netmask.png][subnet netmask]]

#+BEGIN_SRC sh
 route add 192.168.1.0 mask 255.255.255.0 10.10.49.48
#+END_SRC


#+BEGIN_SRC plantuml :file ../attach/xiaomi_subnet.png
  title subnet
  partition office lan
  (*) --> "Desktop 10.10.49.41"
  note right
    subnet 10.10.49.0/24
  end note
  --> "Xiaomi openwrt router 10.10.49.48"
  --> Route
  note left
    The router is bridged to 192.168.1.1
  end note
  end partition

  partition xiaomi
  --> Route
  --> "Xiaomi openwrt router 192.168.1.1"
  --> "Laptop 192.168.1.189"
  --> (*)
  end partition
#+END_SRC

